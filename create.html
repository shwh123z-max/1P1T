<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knitting Host</title>
    
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        * { box-sizing: border-box; } 

        /* [í…Œë§ˆ ì»¬ëŸ¬ ì •ì˜] ë”°ëœ»í•œ ê²¨ìš¸ ë‹ˆíŠ¸ ìƒ‰ê° */
        :root {
            --bg-color: #3E2723;       /* ì§™ì€ ê°ˆìƒ‰ ë°°ê²½ */
            --panel-color: #4E342E;    /* íŒ¨ë„ ë°°ê²½ */
            --text-color: #EFEBE9;     /* ì—°í•œ ë² ì´ì§€ í…ìŠ¤íŠ¸ */
            --accent-green: #2E7D32;   /* ì°¨ë¶„í•œ ì´ˆë¡ */
            --accent-red: #C62828;     /* ì°¨ë¶„í•œ ë¹¨ê°• */
            --card-base: #D7CCC8;      /* ë‹ˆíŠ¸ ê¸°ë³¸ ë² ì´ì§€ */
        }

        body { 
            font-family: 'Pretendard', sans-serif; 
            background: var(--bg-color); 
            color: var(--text-color); 
            display: flex; justify-content: center; align-items: flex-start; 
            min-height: 100vh; margin: 0; padding: 40px 20px; 
        }
        
        .container { 
            background: var(--panel-color); 
            padding: 40px; 
            border-radius: 24px; 
            width: 100%; max-width: 1200px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .screen { display: none; animation: fadeIn 0.5s ease; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* [ë ˆì´ì•„ì›ƒ] ì¢Œìš° 2ë‹¨ ë¶„í•  */
        .dashboard-layout { display: flex; flex-direction: column; gap: 40px; }
        @media (min-width: 1024px) {
            .dashboard-layout { flex-direction: row; align-items: flex-start; }
            .left-panel { flex: 2; } 
            .right-panel { flex: 1; position: sticky; top: 20px; min-width: 300px;} 
        }

        h2, h3 { margin-top: 0; font-weight: 700; letter-spacing: -0.5px; }
        h2 { font-size: 28px; margin-bottom: 20px; color: #FFECB3; }
        h3 { font-size: 18px; margin-bottom: 15px; color: #D7CCC8; border-bottom: 2px solid rgba(255,255,255,0.1); padding-bottom: 10px;}

        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        textarea { 
            width: 100%; height: 120px; padding: 20px; 
            font-size: 24px; text-align: center; text-transform: uppercase; 
            background: rgba(0,0,0,0.2); color: #fff;
            border: 2px dashed rgba(255,255,255,0.2); border-radius: 16px; 
            resize: none; font-family: monospace; font-weight: bold; outline: none;
            transition: 0.3s;
        }
        textarea:focus { border-color: var(--accent-green); background: rgba(0,0,0,0.3); }

        input[type="datetime-local"], input[type="text"] { 
            width: 100%; padding: 15px; 
            border-radius: 12px; border: none; 
            background: #fff; font-size: 16px; margin-bottom: 20px; 
            font-family: inherit;
        }

        button { 
            width: 100%; padding: 18px; 
            background-color: var(--accent-green); color: white; 
            border: none; border-radius: 12px; 
            font-size: 18px; font-weight: bold; cursor: pointer; 
            transition: 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        button:hover { transform: translateY(-2px); filter: brightness(1.1); }
        button:disabled { background: #777; cursor: not-allowed; transform: none; }
        
        button.final { background-color: var(--accent-red); margin-top: 20px; }
        button.secondary { background-color: #6D4C41; width: auto; font-size: 14px; padding: 12px 20px;}

        /* [ìˆ˜ì •] ë¼ì´ë¸Œ ìº”ë²„ìŠ¤ ê·¸ë¦¬ë“œ (ì˜ë¦¼ ë°©ì§€) */
        .grid-box { 
            background: rgba(0,0,0,0.2); 
            padding: 30px; 
            border-radius: 20px; 
            /* Flex Wrapìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ì¤„ë°”ê¿ˆ í—ˆìš© -> ì˜ë¦¼ í•´ê²° */
            display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;
            width: 100%; min-height: 200px;
            overflow: visible; /* ìì‹ ìš”ì†Œ(í™•ëŒ€ëœ ì¹´ë“œ)ê°€ ì˜ë¦¬ì§€ ì•Šê²Œ í•¨ */
        }
        
        /* ì¹´ë“œ ìŠ¬ë¡¯ ìŠ¤íƒ€ì¼ */
        .slot { 
            width: 80px; height: 80px; 
            position: relative; perspective: 1000px; z-index: 1; cursor: pointer;
        }
        .slot:hover { z-index: 100; } /* í˜¸ë²„ ì‹œ ë§¨ ìœ„ë¡œ */

        .flip-inner {
            position: relative; width: 100%; height: 100%;
            text-align: center; transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d; border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* í˜¸ë²„ íš¨ê³¼ */
        .slot:hover .flip-inner { transform: rotateY(180deg) scale(2.5); box-shadow: 0 20px 40px rgba(0,0,0,0.6); }

        .flip-front, .flip-back {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            display: flex; align-items: center; justify-content: center;
            border-radius: 10px; overflow: hidden;
        }

        .flip-front { background: var(--card-base); }
        .flip-front img { width: 100%; height: 100%; object-fit: cover; }
        .flip-front.empty { background: transparent; border: 2px dashed rgba(255,255,255,0.1); }

        .flip-back {
            background: #FFF8E1; color: #333; transform: rotateY(180deg);
            padding: 5px; flex-direction: column; 
            border: 2px solid var(--accent-red);
        }
        .flip-back strong { font-size: 6px; color: var(--accent-red); display: block; margin-bottom: 2px; }
        .flip-back .msg { font-size: 5px; line-height: 1.2; word-break: break-all; }

        /* ê²°ê³¼ ì˜ì—­ (ì´ˆê¸°ì—” ìˆ¨ê¹€) */
        #result-wrapper { display: none; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 20px; text-align: center; margin-top: 30px; animation: fadeIn 0.5s; border: 1px solid rgba(255,255,255,0.1); }
        #final-img { max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 5px solid #fff; }

        /* ìš°ì¸¡ íŒ¨ë„ ìš”ì†Œ */
        .info-card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 16px; margin-bottom: 20px; }
        .link-text { color: #81C784; font-family: monospace; word-break: break-all; font-size: 13px; margin-top: 5px; display: block; text-decoration: none;}
        
        #message-list { max-height: 400px; overflow-y: auto; }
        .msg-item { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; gap: 10px; align-items: center; }
        .msg-item img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: var(--card-base); }
        .msg-info { text-align: left; }
        .msg-user { font-weight: bold; color: #FFECB3; font-size: 14px; }
        .msg-body { font-size: 13px; color: #ddd; margin-top: 3px; }

        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="screen-setup" class="screen active">
            <h2 style="text-align: center;">ğŸ§¶ ì¹´ë“œ ëœ¨ê°œì§ˆ ë°© ë§Œë“¤ê¸°</h2>
            <div style="max-width: 500px; margin: 0 auto;">
                <p style="text-align: center; color:#aaa; margin-bottom:20px;">ì¹œêµ¬ë“¤ì´ ì±„ì›Œì¤„ ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                <textarea id="TextInput" placeholder="HELLO" maxlength="30" oninput="handleInput()"></textarea>
                
                <p style="text-align: left; margin-bottom: 5px; font-weight: bold; color:#D7CCC8;">ì˜¤í”ˆ ì‹œê°„ (D-Day)</p>
                <input type="datetime-local" id="TimeInput">
                
                <div id="preview-box" class="grid-box" style="margin: 20px 0; min-height: 100px;"></div> 
                
                <button onclick="createRoom()">ì´ëŒ€ë¡œ ë°© ìƒì„±í•˜ê¸°</button>

                <div style="margin-top: 40px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; text-align: center;">
                    <span style="color:#aaa; font-size: 14px;">ê¸°ì¡´ ë°©ìœ¼ë¡œ ëŒì•„ê°€ê¸°</span>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
                        <input type="text" id="RejoinId" placeholder="Room ID" style="width: 150px; margin:0; text-align: center;">
                        <button class="secondary" onclick="manualRejoin()">ì…ì¥</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="screen-dashboard" class="screen">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 30px;">
                <div>
                    <h2 style="margin:0;">ğŸ§¶ <span id="room-id-display" style="color:#FFECB3;"></span></h2>
                    <span id="d-day-badge" style="background:#C62828; padding:3px 8px; border-radius:5px; font-size:12px; font-weight:bold;">D-Day ì„¤ì •ë¨</span>
                </div>
                <button class="secondary" onclick="goHome()">ğŸ  í™ˆìœ¼ë¡œ</button>
            </div>

            <div class="dashboard-layout">
                <div class="left-panel">
                    <h3>ğŸ–¼ï¸ ë¼ì´ë¸Œ ìº”ë²„ìŠ¤ (ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¤ë³´ì„¸ìš”!)</h3>
                    <div id="live-grid" class="grid-box"></div>

                    <div id="result-wrapper">
                        <h3>ğŸ‰ ì™„ì„±ëœ ë‹ˆíŠ¸ ì¹´ë“œ</h3>
                        <img id="final-img" src="" alt="ìƒì„±ëœ ì¹´ë“œ">
                        <div style="margin-top: 15px;">
                            <button class="secondary" onclick="downloadImg()">ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ğŸ’¾</button>
                        </div>
                    </div>
                </div>

                <div class="right-panel">
                    <div class="info-card">
                        <h3>ğŸ”— ì¹œêµ¬ ì´ˆëŒ€</h3>
                        <div style="font-size: 13px; color:#aaa;">ì•„ë˜ ë§í¬ë¥¼ ì¹œêµ¬ì—ê²Œ ë³´ë‚´ì£¼ì„¸ìš”</div>
                        <a id="share-link" href="#" target="_blank" class="link-text">ë§í¬ ìƒì„± ì¤‘...</a>
                        <button class="secondary" style="margin-top: 10px; width: 100%;" onclick="copyLink()">ë§í¬ ë³µì‚¬í•˜ê¸°</button>
                    </div>

                    <div class="info-card">
                        <h3>ğŸ’Œ ë„ì°©í•œ ë©”ì‹œì§€</h3>
                        <div id="message-list">
                            <div style="text-align:center; color:#666; padding: 20px;">ì•„ì§ ë„ì°©í•œ í¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                        </div>
                    </div>

                    <div class="info-card" style="border: 1px solid var(--accent-red);">
                        <h3>ğŸ ìµœì¢… ì¹´ë“œ</h3>
                        <p style="font-size: 13px; color:#ddd; margin-bottom: 15px;">
                            ì¹œêµ¬ë“¤ì´ ëª¨ë‘ ì°¸ì—¬í–ˆê±°ë‚˜<br>
                            D-Dayê°€ ë˜ë©´ ìƒì„±í•´ì£¼ì„¸ìš”.
                        </p>
                        <button class="final" id="make-btn" onclick="makeFinalCard()">ì§€ê¸ˆ ì¹´ë“œ ìƒì„±í•˜ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let myRoomId = null;
        let openTime = null;

        // URL íŒŒë¼ë¯¸í„° í™•ì¸ (ì¬ì…ì¥)
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');
            if (roomId) rejoinRoom(roomId);
        };

        // --- ê¸°ëŠ¥ í•¨ìˆ˜ ---

        function handleInput() {
            const ta = document.getElementById('TextInput');
            // ì˜ë¬¸ ëŒ€ë¬¸ìì™€ ê³µë°±ë§Œ í—ˆìš©
            ta.value = ta.value.toUpperCase().replace(/[^A-Z\n ]/g, "");
            updatePreview(ta.value);
        }

        function updatePreview(text) {
            const box = document.getElementById('preview-box');
            box.innerHTML = '';
            // ê°„ë‹¨ í”„ë¦¬ë·° (í”Œë¦½ ì—†ì´)
            for(let char of text) {
                if(char === '\n') {
                    const br = document.createElement('div');
                    br.style.width = '100%'; 
                    box.appendChild(br);
                    continue;
                }
                const div = document.createElement('div');
                div.className = 'slot';
                div.style.width = '40px'; div.style.height = '40px'; // ë¯¸ë¦¬ë³´ê¸°ëŠ” ì‘ê²Œ
                div.style.background = (char === ' ') ? 'transparent' : '#D7CCC8';
                div.style.border = (char === ' ') ? '1px dashed #666' : 'none';
                div.style.borderRadius = '5px';
                div.style.display = 'flex'; div.style.alignItems='center'; div.style.justifyContent='center';
                div.style.color = '#3e2723'; div.style.fontWeight='bold';
                div.innerText = char;
                box.appendChild(div);
            }
        }

        async function createRoom() {
            const text = document.getElementById('TextInput').value;
            const time = document.getElementById('TimeInput').value;
            if(!text.trim() || !time) return alert("ë¬¸êµ¬ì™€ ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!");

            // ì¤„ë°”ê¿ˆ ê¸°ì¤€ìœ¼ë¡œ ìµœëŒ€ ê¸¸ì´ ê³„ì‚° (ì§ì‚¬ê°í˜• ëª¨ì–‘ ìœ ì§€ ìœ„í•´ íŒ¨ë”©)
            const lines = text.split('\n');
            let maxLen = 0;
            lines.forEach(l => maxLen = Math.max(maxLen, l.length));
            let paddedText = "";
            lines.forEach(l => paddedText += l.padEnd(maxLen, " "));

            try {
                const res = await fetch('/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: paddedText, columns: maxLen, open_time: time })
                });
                const data = await res.json();
                rejoinRoom(data.room_id);
            } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
        }

        function manualRejoin() {
            const rid = document.getElementById('RejoinId').value.trim();
            if(rid) rejoinRoom(rid);
        }

        async function rejoinRoom(roomId) {
            myRoomId = roomId;
            try {
                const res = await fetch(`/status/${roomId}`);
                const data = await res.json();
                if(data.error) {
                    alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤.");
                    window.history.pushState({}, '', '/host');
                    return;
                }

                // í™”ë©´ ì „í™˜
                document.getElementById('screen-setup').classList.remove('active');
                document.getElementById('screen-dashboard').classList.add('active');
                
                // ì •ë³´ ì—…ë°ì´íŠ¸
                openTime = new Date(data.open_time);
                document.getElementById('room-id-display').innerText = `ROOM: ${roomId}`;
                
                const dDayStr = openTime.toLocaleString([], {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
                document.getElementById('d-day-badge').innerText = `OPEN: ${dDayStr}`;

                const url = window.location.origin + "/?room=" + roomId;
                const linkEl = document.getElementById('share-link');
                linkEl.href = url; linkEl.innerText = url;
                window.history.pushState({}, '', '/host?room='+roomId);

                // ë¼ì´ë¸Œ ë Œë”ë§
                renderLiveGrid(data.slots);
                updateMessageList(data.slots);

                // ì´ë¯¸ ìƒì„±ëœ ì¹´ë“œê°€ ìˆëŠ”ì§€ í™•ì¸
                checkFinalCard();

                // ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ ì‹œì‘
                setInterval(() => fetchLiveStatus(), 3000);

            } catch(e) { console.error(e); alert("ë°© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); }
        }

        async function fetchLiveStatus() {
            if(!myRoomId) return;
            const res = await fetch(`/status/${myRoomId}`);
            const data = await res.json();
            if(!data.error) {
                renderLiveGrid(data.slots);
                updateMessageList(data.slots);
            }
        }

        function renderLiveGrid(slots) {
            const box = document.getElementById('live-grid');
            box.innerHTML = '';

            slots.forEach(slot => {
                const el = document.createElement('div');
                el.className = 'slot';
                
                // ë¹ˆ ì¹¸
                if(slot.char === ' ') {
                    // íˆ¬ëª… ê³µê°„ ìœ ì§€
                    el.style.visibility = 'hidden'; 
                } else {
                    // ì¹´ë“œ ë‚´ìš©
                    let frontContent = '';
                    let backContent = `<div style="color:#aaa">ì‘ì„± ì „</div>`;

                    if(slot.is_filled) {
                        const t = new Date().getTime();
                        frontContent = `<img src="/img/${myRoomId}/${slot.position}?t=${t}">`;
                        backContent = `
                            <strong>From. ${slot.user}</strong>
                            <div class="msg">${slot.message}</div>
                        `;
                    } else {
                        frontContent = `<div style="font-size:24px; font-weight:bold; color:#8D6E63;">${slot.char}</div>`;
                    }

                    el.innerHTML = `
                        <div class="flip-inner">
                            <div class="flip-front ${slot.is_filled?'':'empty'}">${frontContent}</div>
                            <div class="flip-back">${backContent}</div>
                        </div>
                    `;
                }
                box.appendChild(el);
            });
        }

        function updateMessageList(slots) {
            const list = document.getElementById('message-list');
            const filled = slots.filter(s => s.is_filled);
            
            if(filled.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#666; padding: 20px;">ì•„ì§ ë„ì°©í•œ í¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            list.innerHTML = '';
            filled.forEach(s => {
                const t = new Date().getTime();
                const div = document.createElement('div');
                div.className = 'msg-item';
                div.innerHTML = `
                    <img src="/img/${myRoomId}/${s.position}?t=${t}">
                    <div class="msg-info">
                        <div class="msg-user">${s.user} (${s.char})</div>
                        <div class="msg-body">${s.message}</div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        async function makeFinalCard() {
            if(!myRoomId) return;
            const now = new Date();
            
            // D-Day ì²´í¬ (ê²½ê³ ë§Œ í•˜ê³  ì§„í–‰ì€ ê°€ëŠ¥í•˜ê²Œ í•¨)
            if(now < openTime) {
                if(!confirm("ì•„ì§ ì˜¤í”ˆ ì‹œê°„ì´ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nì§€ê¸ˆ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì¹œêµ¬ë“¤ì´ ë‹¤ ê·¸ë ¸ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”!)")) return;
            }

            const btn = document.getElementById('make-btn');
            btn.disabled = true; btn.innerText = "â³ ë‹ˆíŠ¸ ì§œëŠ” ì¤‘...";

            try {
                await fetch(`/make-card/${myRoomId}`, { method: 'POST' });
                await checkFinalCard(); // ìƒì„± í›„ ì´ë¯¸ì§€ ë¡œë“œ ì‹œë„
                alert("ì¹´ë“œê°€ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ì•„ë˜ì—ì„œ í™•ì¸í•˜ì„¸ìš”.");
            } catch(e) { alert("ìƒì„± ì‹¤íŒ¨"); }
            
            btn.disabled = false; btn.innerText = "ğŸ ìµœì¢… ì¹´ë“œ ìƒì„±í•˜ê¸°";
        }

        async function checkFinalCard() {
            // ì´ë¯¸ì§€ê°€ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ ì²´í¬
            const res = await fetch(`/result_card/${myRoomId}`);
            if(res.ok) {
                const wrapper = document.getElementById('result-wrapper');
                const img = document.getElementById('final-img');
                img.src = `/result_card/${myRoomId}?t=` + new Date().getTime();
                wrapper.style.display = 'block'; // ìˆ¨ê²¨ë’€ë˜ ì˜ì—­ í‘œì‹œ
                
                // ìŠ¤í¬ë¡¤ ì´ë™
                wrapper.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function copyLink() {
            const url = document.getElementById('share-link').href;
            navigator.clipboard.writeText(url).then(() => alert("ì´ˆëŒ€ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"));
        }

        function downloadImg() {
            const src = document.getElementById('final-img').src;
            if(!src) return;
            const a = document.createElement('a');
            a.href = src;
            a.download = `Knitting_Card_${myRoomId}.jpg`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function goHome() {
            if(confirm("ì²« í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) window.location.href = "/host";
        }
    </script>
</body>
</html>
