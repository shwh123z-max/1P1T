<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í˜¸ìŠ¤íŠ¸ ê´€ë¦¬ì</title>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        * { box-sizing: border-box; } 

        body { font-family: 'Pretendard', sans-serif; background: #222; color: white; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 20px; }
        
        .container { background: #333; padding: 2rem; border-radius: 20px; width: 95%; max-width: 1400px; text-align: center; margin-top: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .screen { display: none; }
        .active { display: block; }

        /* [ìˆ˜ì •] 2ë‹¨ ë ˆì´ì•„ì›ƒ ì•ˆì •í™” */
        .dashboard-layout { display: flex; flex-direction: column; gap: 30px; }
        
        @media (min-width: 1024px) {
            .dashboard-layout { flex-direction: row; align-items: flex-start; text-align: left; }
            
            /* â˜… í•µì‹¬ ìˆ˜ì •: min-width: 0 (ì´ê²Œ ì—†ìœ¼ë©´ ë ˆì´ì•„ì›ƒì´ í„°ì§) */
            .left-panel { flex: 1; min-width: 0; } 
            
            /* ì˜¤ë¥¸ìª½ íŒ¨ë„ì€ ê³ ì • í¬ê¸° ìœ ì§€, ì••ì¶• ê¸ˆì§€(flex-shrink: 0) */
            .right-panel { width: 380px; flex-shrink: 0; position: sticky; top: 20px; } 
        }

        textarea { width: 100%; height: 100px; padding: 15px; margin: 15px 0; font-size: 22px; text-align: center; text-transform: uppercase; letter-spacing: 2px; border-radius: 12px; border: none; resize: none; font-family: monospace; background: #eee; font-weight: bold; color: #333; }
        input[type="datetime-local"] { width: 100%; padding: 12px; border-radius: 12px; border: none; font-family: inherit; margin-bottom: 25px; font-size: 16px;}
        input.rejoin-input { width: 60%; padding: 12px; border-radius: 12px; border: none; font-size: 16px; margin-right: 10px; text-align: center;}

        button { width: 100%; padding: 18px; background-color: #00c853; color: white; border: none; border-radius: 12px; font-size: 18px; cursor: pointer; margin-top: 15px; font-weight: bold; transition: 0.2s;}
        button:hover { transform: scale(1.02); opacity: 0.9; }
        button.final { background-color: #d63384; margin-top: 20px; box-shadow: 0 4px 15px rgba(214, 51, 132, 0.4); }
        button.secondary { background-color: #555; width: auto; font-size: 14px; padding: 12px; margin-top: 0;}
        
        /* [NEW] í™ˆ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .home-btn { background: #444; border: 1px solid #666; padding: 8px 15px; border-radius: 8px; font-size: 14px; color: #aaa; cursor: pointer; text-decoration: none; display: inline-block; margin-left: 10px; }
        .home-btn:hover { background: #555; color: white; }

        .grid-box { 
            background: #444; padding: 30px; border-radius: 16px; 
            display: flex; flex-direction: column; gap: 15px; align-items: flex-start; 
            overflow-x: auto; width: 100%; border: 2px dashed #555; min-height: 200px;
        }
        
        .row { display: flex; gap: 10px; width: max-content; }
        
        .slot { width: 80px; height: 80px; background: #555; display: flex; align-items: center; justify-content: center; border-radius: 12px; border: 2px solid #666; color: #ccc; font-weight: bold; font-size: 24px; flex-shrink: 0; position: relative; overflow: hidden;}
        .slot img { width: 100%; height: 100%; object-fit: contain; background: white; }
        .slot.filled { border: 2px solid #ff80ab; animation: pop 0.3s ease; }
        .slot.empty { background: transparent; border: 2px dashed #555; opacity: 0.3; }
        
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        
        #link-box { margin-bottom: 20px; background: #222; padding: 15px; word-break: break-all; border-radius: 12px; border: 1px solid #00c853; font-family: monospace; font-size: 13px;}
        a { color: #69f0ae; text-decoration: none; }

        #message-list { margin-top: 20px; text-align: left; max-height: 500px; overflow-y: auto; padding-right: 5px; }
        .msg-card { background: #444; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; gap: 15px; align-items: center; border: 1px solid #555; }
        .msg-img { width: 50px; height: 50px; background: white; border-radius: 8px; object-fit: contain; border: 1px solid #ddd; flex-shrink: 0; }
        .msg-content { flex: 1; min-width: 0; }
        .msg-name { font-weight: bold; color: #69f0ae; font-size: 14px; margin-bottom: 3px; }
        .msg-text { font-size: 13px; color: #eee; background: #2a2a2a; padding: 8px; border-radius: 8px; word-wrap: break-word; line-height: 1.4;}
        
        #result-area { margin-top: 20px; display: none; background: #222; padding: 15px; border-radius: 16px; border: 2px solid #444;}
        #final-img { max-width: 100%; border-radius: 8px; border: 1px solid #555; }
        
        .rejoin-area { margin-top: 40px; border-top: 1px solid #555; padding-top: 20px; }
        .rejoin-row { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 10px; }
        
        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #666; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        
        <div id="screen-setup" class="screen active" style="max-width: 600px; margin: 0 auto;">
            <h2>ğŸ¨ ë°© ë§Œë“¤ê¸°</h2>
            <textarea id="TextInput" placeholder="MERRY&#10;CHRISTMAS" maxlength="50" oninput="handleInput()"></textarea>
            <input type="datetime-local" id="TimeInput">
            <div id="preview-box" class="grid-box" style="align-items: center; min-height: 100px;"></div> 
            <button onclick="createRoom()">ì´ëŒ€ë¡œ ë°© ìƒì„±</button>

            <div class="rejoin-area">
                <p style="color:#aaa; font-size:14px;">í˜¹ì‹œ ë§Œë“¤ì—ˆë˜ ë°©ì´ ìˆë‚˜ìš”?</p>
                <div class="rejoin-row">
                    <input type="text" id="RejoinId" class="rejoin-input" placeholder="ë°© ID ì…ë ¥">
                    <button class="secondary" onclick="manualRejoin()">ì´ì–´í•˜ê¸°</button>
                </div>
            </div>
        </div>

        <div id="screen-dashboard" class="screen">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                <div style="text-align: left;">
                    <h2 style="margin:0;">ğŸ“¡ ì‹¤ì‹œê°„ í˜„í™©</h2>
                    <div style="font-size:14px; color:#aaa; margin-top:5px;">Room ID: <span id="display-room-id" style="color:#69f0ae; font-weight:bold;"></span></div>
                </div>
                
                <button class="home-btn" onclick="goHome()">ğŸ  ìƒˆ ë°© ë§Œë“¤ê¸°</button>
            </div>

            <div class="dashboard-layout">
                <div class="left-panel">
                    <h3 style="margin-top:0; color:#ddd; text-align: left; font-size: 16px;">ğŸ–¼ï¸ ë¼ì´ë¸Œ ìº”ë²„ìŠ¤</h3>
                    <div id="live-grid" class="grid-box"></div>
                    
                    <div id="result-area">
                        <h3 style="margin: 10px 0; color: #ffeb3b;">ğŸ‰ ì™„ì„±ëœ ì¹´ë“œ</h3>
                        <img id="final-img" src="" alt="ê²°ê³¼ ì´ë¯¸ì§€">
                    </div>
                </div>

                <div class="right-panel">
                    <div id="link-box">
                        <div style="color:#aaa; font-size:12px; margin-bottom:5px;">ì¹œêµ¬ ì´ˆëŒ€ ë§í¬ ğŸ‘‡</div>
                        <a id="share-link" href="#" target="_blank">ë§í¬ ìƒì„± ì¤‘...</a>
                    </div>

                    <button class="final" onclick="makeFinalCard()">ğŸ ìµœì¢… ì¹´ë“œ ìƒì„± & ì €ì¥</button>
                    <p style="font-size:12px; color:#aaa; margin-top:5px; margin-bottom: 30px;">* ì¹œêµ¬ë“¤ì´ ë‹¤ ê·¸ë¦¬ë©´ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>

                    <h3 style="border-top: 1px solid #555; padding-top: 20px;">ğŸ“© ë„ì°©í•œ í¸ì§€í•¨</h3>
                    <div id="message-list">
                        <div style="color:#888; text-align:center;">ì•„ì§ ë„ì°©í•œ í¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentColumns = 5;
        let myRoomId = null;

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');
            if (roomId) { rejoinRoom(roomId); }
        };

        // [NEW] í™ˆìœ¼ë¡œ ê°€ê¸° í•¨ìˆ˜
        function goHome() {
            if(confirm("í˜„ì¬ ë°©ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                window.location.href = "/host"; // ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ì´ë™
            }
        }

        function handleInput() {
            const textarea = document.getElementById('TextInput');
            let val = textarea.value.toUpperCase().replace(/[^A-Z\n ]/g, "");
            textarea.value = val;
            updateGrid(val, 'preview-box');
        }

        function updateGrid(text, elementId) {
            const box = document.getElementById(elementId);
            if(!box) return;
            box.innerHTML = ''; 
            const lines = text.split('\n');
            let maxLen = 0;
            lines.forEach(l => maxLen = Math.max(maxLen, l.length));
            if(elementId === 'preview-box') currentColumns = maxLen;

            lines.forEach(line => {
                if(line.length === 0) return;
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';
                for (let char of line) {
                    const slotDiv = document.createElement('div');
                    slotDiv.className = (char === " ") ? 'slot empty' : 'slot';
                    if(char !== " ") slotDiv.innerText = char;
                    rowDiv.appendChild(slotDiv);
                }
                box.appendChild(rowDiv);
            });
        }

        async function createRoom() {
            const rawText = document.getElementById('TextInput').value;
            const timeVal = document.getElementById('TimeInput').value;
            if(!rawText.trim() || !timeVal) return alert("ë¬¸êµ¬ì™€ ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!");

            const lines = rawText.toUpperCase().split('\n');
            let maxLen = 0;
            lines.forEach(l => maxLen = Math.max(maxLen, l.length));
            let paddedText = "";
            lines.forEach(line => { paddedText += line.padEnd(maxLen, " "); });

            const res = await fetch('/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: paddedText, columns: maxLen, open_time: timeVal })
            });
            const data = await res.json();
            rejoinRoom(data.room_id);
        }

        function manualRejoin() {
            const inputId = document.getElementById('RejoinId').value.trim();
            if(!inputId) return alert("ë°© IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            rejoinRoom(inputId);
        }

        async function rejoinRoom(roomId) {
            myRoomId = roomId;
            const res = await fetch(`/status/${myRoomId}`);
            const data = await res.json();
            
            if(data.error) {
                alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤.");
                window.history.pushState({}, '', '/host');
                return;
            }

            if(data.columns) currentColumns = data.columns;

            document.getElementById('screen-setup').classList.remove('active');
            document.getElementById('screen-dashboard').classList.add('active');
            document.getElementById('display-room-id').innerText = myRoomId;
            
            const newUrl = window.location.pathname + "?room=" + myRoomId;
            window.history.pushState({path: newUrl}, '', newUrl);
            
            const shareUrl = window.location.origin + "/?room=" + myRoomId;
            document.getElementById('share-link').href = shareUrl;
            document.getElementById('share-link').innerText = shareUrl;
            
            renderLiveGrid(data.slots);
            updateMessageList(data.slots);
            setInterval(fetchLiveStatus, 2000);
        }

        async function fetchLiveStatus() {
            if(!myRoomId) return;
            try {
                const res = await fetch(`/status/${myRoomId}`);
                const data = await res.json();
                if(data.error) return; 
                renderLiveGrid(data.slots);
                updateMessageList(data.slots);
            } catch(e) {}
        }

        function renderLiveGrid(slots) {
            const liveBox = document.getElementById('live-grid');
            liveBox.innerHTML = '';
            let currentRow = document.createElement('div');
            currentRow.className = 'row';
            
            slots.forEach((slot, index) => {
                if (index > 0 && index % currentColumns === 0) {
                    liveBox.appendChild(currentRow);
                    currentRow = document.createElement('div');
                    currentRow.className = 'row';
                }
                const slotDiv = document.createElement('div');
                
                if (slot.char === " ") {
                    slotDiv.className = 'slot empty';
                } else {
                    if(slot.is_filled) {
                        slotDiv.className = 'slot filled';
                        const time = new Date().getTime();
                        slotDiv.innerHTML = `<img src="/img/${myRoomId}/${slot.position}?t=${time}">`;
                    } else {
                        slotDiv.className = 'slot';
                        slotDiv.innerText = slot.char;
                    }
                }
                currentRow.appendChild(slotDiv);
            });
            liveBox.appendChild(currentRow);
        }

        function updateMessageList(slots) {
            const list = document.getElementById('message-list');
            const filledSlots = slots.filter(s => s.is_filled && s.user);

            if (filledSlots.length === 0) {
                list.innerHTML = '<div style="color:#888; text-align:center;">ì•„ì§ ë„ì°©í•œ í¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            list.innerHTML = '';
            filledSlots.forEach(slot => {
                const time = new Date().getTime();
                const item = document.createElement('div');
                item.className = 'msg-card';
                item.innerHTML = `
                    <img src="/img/${myRoomId}/${slot.position}?t=${time}" class="msg-img">
                    <div class="msg-content">
                        <div class="msg-name">${slot.user} <span class="msg-char">${slot.char} ë‹´ë‹¹</span></div>
                        <div class="msg-text">${slot.message}</div>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        async function makeFinalCard() {
            if(!myRoomId) return;
            await fetch(`/make-card/${myRoomId}`, { method: 'POST' });
            
            const resultArea = document.getElementById('result-area');
            const resultImg = document.getElementById('final-img');
            const time = new Date().getTime();
            
            resultImg.src = `/result_card/${myRoomId}?t=` + time;
            
            resultArea.style.display = 'block';
            resultArea.scrollIntoView({ behavior: 'smooth' });
            alert("ì¹´ë“œ ìƒì„± ì™„ë£Œ!");
        }
    </script>
</body>
</html>
