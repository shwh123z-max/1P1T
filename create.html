<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knitting Host</title>
    
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        * { box-sizing: border-box; } 

        :root {
            --bg-color: #3E2723;       
            --panel-color: #4E342E;    
            --text-color: #EFEBE9;     
            --accent-green: #2E7D32;   
            --accent-red: #C62828;     
            --card-base: #D7CCC8;      
        }

        body { 
            font-family: 'Pretendard', sans-serif; 
            background: var(--bg-color); color: var(--text-color); 
            display: flex; justify-content: center; align-items: flex-start; 
            min-height: 100vh; margin: 0; padding: 40px 20px; 
        }
        
        .container { 
            background: var(--panel-color); padding: 40px; 
            border-radius: 24px; width: 100%; max-width: 1200px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .screen { display: none; animation: fadeIn 0.5s ease; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .dashboard-layout { display: flex; flex-direction: column; gap: 40px; }
        @media (min-width: 1024px) {
            .dashboard-layout { flex-direction: row; align-items: flex-start; }
            .left-panel { flex: 2; } 
            .right-panel { flex: 1; position: sticky; top: 20px; min-width: 300px;} 
        }

        h2, h3 { margin-top: 0; font-weight: 700; letter-spacing: -0.5px; }
        h2 { font-size: 28px; margin-bottom: 20px; color: #FFECB3; }
        h3 { font-size: 18px; margin-bottom: 15px; color: #D7CCC8; border-bottom: 2px solid rgba(255,255,255,0.1); padding-bottom: 10px;}

        textarea { 
            width: 100%; height: 120px; padding: 20px; 
            font-size: 24px; text-align: center; text-transform: uppercase; 
            background: rgba(0,0,0,0.2); color: #fff;
            border: 2px dashed rgba(255,255,255,0.2); border-radius: 16px; 
            resize: none; font-family: monospace; font-weight: bold; outline: none;
            transition: 0.3s;
        }
        textarea:focus { border-color: var(--accent-green); background: rgba(0,0,0,0.3); }

        /* í˜¸ìŠ¤íŠ¸ ë‹µì¥ìš© í…ìŠ¤íŠ¸ */
        .host-reply-input {
            width: 100%; height: 150px; padding: 20px;
            font-size: 16px; line-height: 1.6;
            background: #FFF8E1; color: #333;
            border: none; border-radius: 10px;
            font-family: 'Pretendard', sans-serif;
            resize: none; margin-bottom: 10px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        input[type="datetime-local"], input[type="text"] { 
            width: 100%; padding: 15px; border-radius: 12px; border: none; 
            background: #fff; font-size: 16px; margin-bottom: 20px; 
            font-family: inherit;
        }

        button { 
            width: 100%; padding: 18px; 
            background-color: var(--accent-green); color: white; 
            border: none; border-radius: 12px; 
            font-size: 18px; font-weight: bold; cursor: pointer; 
            transition: 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        button:hover { transform: translateY(-2px); filter: brightness(1.1); }
        button:disabled { background: #777; cursor: not-allowed; transform: none; opacity: 0.7; }
        
        button.final { background-color: var(--accent-red); margin-top: 20px; }
        button.secondary { background-color: #6D4C41; width: auto; font-size: 14px; padding: 12px 20px;}

        /* ë¼ì´ë¸Œ ìº”ë²„ìŠ¤ */
        .grid-box { 
            background: #444; padding: 40px; border-radius: 16px; 
            display: flex; flex-direction: column; align-items: center; 
            overflow-x: auto; width: 100%; border: 2px dashed #555; min-height: 300px;
        }
        .row { display: flex; width: max-content; margin: 0; padding: 0; } 
        
        .slot { 
            width: 70px; height: 70px; 
            background: transparent; perspective: 1000px;
            margin: 0; padding: 0; border: none; flex-shrink: 0; position: relative; z-index: 1;
        }
        /* D-Dayê°€ ë˜ì—ˆì„ ë•Œë§Œ í˜¸ë²„ íš¨ê³¼ í™œì„±í™” (JSë¡œ ì œì–´) */
        .slot.unlocked:hover { z-index: 100; }
        .slot.unlocked:hover .flip-inner { transform: rotateY(180deg) scale(2.5); box-shadow: 0 20px 40px rgba(0,0,0,0.6); }

        .flip-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d; border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .flip-front, .flip-back {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            display: flex; align-items: center; justify-content: center;
            border-radius: 10px; overflow: hidden;
        }

        .flip-front { background: var(--card-base); }
        .flip-front img { width: 100%; height: 100%; object-fit: cover; }
        
        /* ì ê¹€ ìƒíƒœ ìŠ¤íƒ€ì¼ */
        .locked-gift { font-size: 30px; }

        .flip-back {
            background: #FFF8E1; color: #333; transform: rotateY(180deg);
            padding: 5px; flex-direction: column; border: 2px solid var(--accent-red);
        }
        .flip-back strong { font-size: 6px; color: var(--accent-red); display: block; margin-bottom: 2px; }
        .flip-back .msg { font-size: 5px; line-height: 1.2; word-break: break-all; }

        .slot.empty .flip-front { background: transparent; border: 1px dashed #666; opacity: 0.2; }
        
        #result-wrapper { display: none; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 20px; text-align: center; margin-top: 30px; animation: fadeIn 0.5s; border: 1px solid rgba(255,255,255,0.1); }
        #final-img { max-width: 100%; width: auto; height: auto; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 5px solid #fff; display: inline-block; }

        /* ë‹µì¥ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        #host-reply-card {
            background: #FFF8E1; color: #3E2723;
            padding: 30px; border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: left; position: relative;
            margin-top: 20px; display: none; /* ì´ˆê¸°ì—” ìˆ¨ê¹€ */
            border: 2px solid var(--accent-green);
        }
        .reply-header { font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #ddd; padding-bottom: 10px; display: flex; justify-content: space-between; }

        .info-card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 16px; margin-bottom: 20px; }
        .link-text { color: #81C784; font-family: monospace; word-break: break-all; font-size: 13px; margin-top: 5px; display: block; text-decoration: none;}
        
        #message-list { max-height: 400px; overflow-y: auto; }
        .msg-item { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; gap: 10px; align-items: center; }
        .msg-icon { width: 40px; height: 40px; border-radius: 50%; background: #555; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .msg-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: var(--card-base); }
        .msg-info { text-align: left; flex: 1; }
        .msg-user { font-weight: bold; color: #FFECB3; font-size: 14px; }
        .msg-body { font-size: 13px; color: #ddd; margin-top: 3px; }
        .blur-text { filter: blur(4px); opacity: 0.7; user-select: none; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        
        <div id="screen-setup" class="screen active">
            <h2 style="text-align: center;">ğŸ§¶ ì¹´ë“œ ëœ¨ê°œì§ˆ ë°© ë§Œë“¤ê¸°</h2>
            <div style="max-width: 500px; margin: 0 auto;">
                <p style="text-align: center; color:#aaa; margin-bottom:20px;">ì¹œêµ¬ë“¤ì´ ì±„ì›Œì¤„ ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                <textarea id="TextInput" placeholder="HELLO" maxlength="30" oninput="handleInput()"></textarea>
                
                <p style="text-align: left; margin-bottom: 5px; font-weight: bold; color:#D7CCC8;">ì˜¤í”ˆ ì‹œê°„ (D-Day)</p>
                <input type="datetime-local" id="TimeInput">
                
                <div id="preview-box" class="grid-box" style="margin: 20px 0; min-height: 100px;"></div> 
                
                <button onclick="createRoom()">ë°© ìƒì„±í•˜ê¸°</button>

                <div style="margin-top: 40px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; text-align: center;">
                    <span style="color:#aaa; font-size: 14px;">ê¸°ì¡´ ë°© ì…ì¥</span>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
                        <input type="text" id="RejoinId" placeholder="Room ID" style="width: 150px; margin:0; text-align: center;">
                        <button class="secondary" onclick="manualRejoin()">ì…ì¥</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="screen-dashboard" class="screen">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 30px;">
                <div>
                    <h2 style="margin:0;">ğŸ§¶ <span id="room-id-display" style="color:#FFECB3;"></span></h2>
                    <span id="d-day-badge" style="background:#555; padding:3px 8px; border-radius:5px; font-size:12px; font-weight:bold; color:#aaa;">ğŸ”’ ì ê¹€</span>
                </div>
                <button class="secondary" onclick="goHome()">ğŸ  í™ˆìœ¼ë¡œ</button>
            </div>

            <div class="dashboard-layout">
                <div class="left-panel">
                    <h3>ğŸ–¼ï¸ ë¼ì´ë¸Œ ìº”ë²„ìŠ¤</h3>
                    <div id="live-grid" class="grid-box"></div>

                    <div id="result-wrapper">
                        <h3>ğŸ‰ ì™„ì„±ëœ ë‹ˆíŠ¸ ì¹´ë“œ</h3>
                        <img id="final-img" src="" alt="ìƒì„±ëœ ì¹´ë“œ">
                        
                        <div style="margin-top: 20px;">
                            <button class="secondary" onclick="showReplyForm()">âœï¸ ë’·ë©´ì— ë‹µì¥ ì“°ê¸°</button>
                            <button class="secondary" onclick="downloadImg()">ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ğŸ’¾</button>
                        </div>

                        <div id="host-reply-card">
                            <div class="reply-header">
                                <span>To. Friends</span>
                                <span>From. Host</span>
                            </div>
                            <div id="reply-content-display" style="white-space: pre-wrap; font-size:18px; line-height:1.6;"></div>
                        </div>
                    </div>
                    
                    <div id="reply-form" style="display:none; margin-top:20px; background:rgba(0,0,0,0.3); padding:20px; border-radius:10px;">
                        <h4 style="margin-top:0; color:#fff;">ì¹œêµ¬ë“¤ì—ê²Œ ë³´ë‚¼ ë‹µì¥</h4>
                        <textarea class="host-reply-input" id="hostReplyText" placeholder="ì°¸ì—¬í•´ì¤˜ì„œ ê³ ë§ˆì›Œ! ë©”ë¦¬ í¬ë¦¬ìŠ¤ë§ˆìŠ¤!"></textarea>
                        <div style="display:flex; gap:10px;">
                            <button onclick="saveReply()">ì™„ë£Œ (ì¹´ë“œ ë’·ë©´ì— ë¶™ì´ê¸°)</button>
                            <button class="secondary" onclick="document.getElementById('reply-form').style.display='none'">ì·¨ì†Œ</button>
                        </div>
                    </div>
                </div>

                <div class="right-panel">
                    <div class="info-card">
                        <h3>ğŸ”— ì¹œêµ¬ ì´ˆëŒ€</h3>
                        <a id="share-link" href="#" target="_blank" class="link-text">ë§í¬ ìƒì„± ì¤‘...</a>
                        <button class="secondary" style="margin-top: 10px; width: 100%;" onclick="copyLink()">ë§í¬ ë³µì‚¬í•˜ê¸°</button>
                    </div>

                    <div class="info-card">
                        <h3>ğŸ’Œ ë„ì°©í•œ ë©”ì‹œì§€</h3>
                        <div id="message-list"></div>
                    </div>

                    <div class="info-card" style="border: 1px solid var(--accent-red);">
                        <h3>ğŸ ìµœì¢… ì¹´ë“œ</h3>
                        <p id="make-desc" style="font-size: 13px; color:#ddd; margin-bottom: 15px;">
                            ì•„ì§ ì˜¤í”ˆ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.<br>ì‹œê°„ì´ ë˜ë©´ ì¹´ë“œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.
                        </p>
                        <button class="final" id="make-btn" onclick="makeFinalCard()" disabled>ğŸ”’ D-Day ëŒ€ê¸° ì¤‘</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let myRoomId = null;
        let openTime = null;
        let isOpened = false; // D-Day ë„ë‹¬ ì—¬ë¶€

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');
            if (roomId) rejoinRoom(roomId);
        };

        function handleInput() {
            const ta = document.getElementById('TextInput');
            ta.value = ta.value.toUpperCase().replace(/[^A-Z\n ]/g, "");
            updatePreview(ta.value);
        }

        function updatePreview(text) {
            const box = document.getElementById('preview-box');
            box.innerHTML = '';
            for(let char of text) {
                if(char === '\n') {
                    const br = document.createElement('div'); br.style.width = '100%'; box.appendChild(br); continue;
                }
                const div = document.createElement('div');
                div.className = 'slot'; div.style.width='40px'; div.style.height='40px';
                div.style.background = (char === ' ') ? 'transparent' : '#D7CCC8';
                div.style.border = (char === ' ') ? '1px dashed #666' : 'none';
                div.style.borderRadius = '5px';
                div.style.display = 'flex'; div.style.alignItems='center'; div.style.justifyContent='center';
                div.style.color = '#3e2723'; div.style.fontWeight='bold'; div.innerText = char;
                box.appendChild(div);
            }
        }

        async function createRoom() {
            const text = document.getElementById('TextInput').value;
            const time = document.getElementById('TimeInput').value;
            if(!text.trim() || !time) return alert("ë¬¸êµ¬ì™€ ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!");

            const lines = text.split('\n');
            let maxLen = 0; lines.forEach(l => maxLen = Math.max(maxLen, l.length));
            let paddedText = ""; lines.forEach(l => paddedText += l.padEnd(maxLen, " "));

            try {
                const res = await fetch('/create', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: paddedText, columns: maxLen, open_time: time })
                });
                const data = await res.json();
                rejoinRoom(data.room_id);
            } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
        }

        function manualRejoin() {
            const rid = document.getElementById('RejoinId').value.trim();
            if(rid) rejoinRoom(rid);
        }

        async function rejoinRoom(roomId) {
            myRoomId = roomId;
            try {
                const res = await fetch(`/status/${roomId}`);
                const data = await res.json();
                if(data.error) { alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤."); window.history.pushState({}, '', '/host'); return; }

                document.getElementById('screen-setup').classList.remove('active');
                document.getElementById('screen-dashboard').classList.add('active');
                
                openTime = new Date(data.open_time);
                document.getElementById('room-id-display').innerText = `ROOM: ${roomId}`;
                
                const url = window.location.origin + "/?room=" + roomId;
                document.getElementById('share-link').href = url;
                document.getElementById('share-link').innerText = url;
                window.history.pushState({}, '', '/host?room='+roomId);

                checkTime(); // ì‹œê°„ ì²´í¬
                renderLiveGrid(data.slots);
                updateMessageList(data.slots);
                
                // ì´ë¯¸ ìƒì„±ëœê²Œ ìˆìœ¼ë©´ ë³´ì—¬ì¤Œ
                checkFinalCard();

                setInterval(() => {
                    checkTime();
                    fetchLiveStatus();
                }, 3000);

            } catch(e) { console.error(e); alert("ë°© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); }
        }

        function checkTime() {
            const now = new Date();
            const badge = document.getElementById('d-day-badge');
            const btn = document.getElementById('make-btn');
            const desc = document.getElementById('make-desc');

            if (now >= openTime) {
                isOpened = true;
                badge.style.background = "#C62828"; 
                badge.style.color = "white";
                badge.innerText = "ğŸ‰ OPEN!";
                
                btn.disabled = false;
                btn.innerText = "ğŸ ìµœì¢… ì¹´ë“œ ìƒì„±í•˜ê¸°";
                desc.innerText = "ì˜¤í”ˆ ì‹œê°„ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!\nì¹œêµ¬ë“¤ì˜ ì„ ë¬¼ì„ í™•ì¸í•´ë³´ì„¸ìš”.";
            } else {
                isOpened = false;
                const diff = Math.ceil((openTime - now) / (1000 * 60)); // ë¶„ ë‹¨ìœ„
                badge.innerText = `ğŸ”’ D-Day (${diff}ë¶„ ì „)`;
                
                btn.disabled = true;
                btn.innerText = "ğŸ”’ ì˜¤í”ˆ ëŒ€ê¸° ì¤‘";
            }
        }

        async function fetchLiveStatus() {
            if(!myRoomId) return;
            const res = await fetch(`/status/${myRoomId}`);
            const data = await res.json();
            if(!data.error) {
                renderLiveGrid(data.slots);
                updateMessageList(data.slots);
            }
        }

        function renderLiveGrid(slots) {
            const box = document.getElementById('live-grid');
            box.innerHTML = '';

            // ì¤‘ì•™ ì •ë ¬ ë° ì¤„ë°”ê¿ˆ
            box.style.display = 'flex';
            box.style.flexDirection = 'column';
            box.style.alignItems = 'center';

            let currentColumns = 0;
            // ì»¬ëŸ¼ ìˆ˜ ì¶”ì • (ì²« ì¤„ ê¸¸ì´)
            if(slots.length > 0) {
                // ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ ê¸°ì¡´ ë³€ìˆ˜ ì‚¬ìš© or ê³„ì‚°
            }

            // ê°„ë‹¨í•˜ê²Œ row ë‹¨ìœ„ ë Œë”ë§ ë§ê³ , ê·¸ëƒ¥ flex-wrapìœ¼ë¡œ ë¿Œë¦¬ë˜
            // ì´ë²ˆì—” ê¸°ì¡´ì˜ row êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ëŠ”ê²Œ ì•ˆì „í•¨ (ì¤„ë°”ê¿ˆì´ í…ìŠ¤íŠ¸ í˜•íƒœë‹ˆê¹Œ)
            // ë°ì´í„°ì— columns ì •ë³´ê°€ ìˆìœ¼ë‹ˆ ê·¸ê±¸ ì”ë‹ˆë‹¤.
            const cols = 5; // ì„ì‹œê°’, ì‹¤ì œë¡  data.columnsê°€ í•„ìš”í•˜ì§€ë§Œ ì—¬ê¸°ì„  slotsë§Œ ë°›ìŒ.
            // main.pyì—ì„œ columnsë¥¼ ë³´ë‚´ì£¼ë¯€ë¡œ rejoinRoomì—ì„œ ì „ì—­ë³€ìˆ˜ë¡œ ì €ì¥í•˜ëŠ”ê²Œ ì¢‹ìŒ.
            // í•˜ì§€ë§Œ ì—¬ê¸°ì„  ê·¸ëƒ¥ 'ì¤„ë°”ê¿ˆ' ë¬¸ì ëŒ€ì‹  index ê³„ì‚°ìœ¼ë¡œ rowë¥¼ ë‚˜ëˆ•ë‹ˆë‹¤.
            
            // ê¸°ì¡´ ë¡œì§ ì¬í™œìš© (row div ìƒì„±)
            // *ì£¼ì˜*: í™”ë©´ ë¦¬ë‰´ì–¼í•˜ë©´ì„œ grid-box ìŠ¤íƒ€ì¼ì„ ë°”ê¿¨ìŒ.
            // slotì„ ê·¸ëƒ¥ ë‚˜ì—´í•˜ì§€ ì•Šê³  row divë¡œ ê°ì‹¸ì•¼ ì¤„ë°”ê¿ˆì´ ì •ìƒì ìœ¼ë¡œ ë¨.
            
            // Re-fetch data.columns logic needed or handle simply:
            // ì´ì „ ì½”ë“œ ë¡œì§ ì°¨ìš©
            
            // ìŠ¬ë¡¯ ë Œë”ë§ (ê°„ë‹¨ ë²„ì „)
            // row div ì—†ì´ flex-wrapìœ¼ë¡œ í•˜ë ¤ë©´ widthë¥¼ ê³ ì •í•´ì•¼ í•¨.
            // ê·¸ëƒ¥ row div ë°©ì‹ ìœ ì§€
            
            // *** ì¤‘ìš”: updateMessageList ë“±ì—ì„œ dataë¥¼ ë°›ì•„ì„œ ì „ì—­ë³€ìˆ˜ currentCols ì €ì¥ í•„ìš” ***
            // ì„ì‹œ ë°©í¸: status APIê°€ columnsë¥¼ ì¤Œ.
        }
        
        // [ìˆ˜ì •] renderLiveGridë¥¼ fetchLiveStatus ì•ˆì—ì„œ ë°›ì€ columnsë¡œ ì²˜ë¦¬í•˜ë„ë¡ ë³€ê²½ í•„ìš”.
        // í•˜ì§€ë§Œ ì—¬ê¸°ì„  ê°„ë‹¨íˆ DOMì„ ì‹¹ ë¹„ìš°ê³  ë‹¤ì‹œ ê·¸ë¦¬ëŠ” ë°©ì‹ ìœ ì§€.
        
        // *ì‹¤ì œ êµ¬í˜„*
        async function fetchLiveStatus() {
            if(!myRoomId) return;
            const res = await fetch(`/status/${myRoomId}`);
            const data = await res.json();
            if(!data.error) {
                renderLiveGridV2(data.slots, data.columns);
                updateMessageList(data.slots);
            }
        }

        function renderLiveGridV2(slots, cols) {
            const box = document.getElementById('live-grid');
            box.innerHTML = '';
            
            let rowDiv = document.createElement('div');
            rowDiv.className = 'row';
            
            slots.forEach((slot, idx) => {
                if (idx > 0 && idx % cols === 0) {
                    box.appendChild(rowDiv);
                    rowDiv = document.createElement('div');
                    rowDiv.className = 'row';
                }

                const el = document.createElement('div');
                // ê³µê°œ ì—¬ë¶€ì— ë”°ë¼ í´ë˜ìŠ¤ ì¶”ê°€ (í˜¸ë²„ ê°€ëŠ¥/ë¶ˆê°€ëŠ¥)
                el.className = isOpened ? 'slot unlocked' : 'slot';
                
                if(slot.char === ' ') {
                    el.style.visibility = 'hidden'; 
                } else {
                    let frontContent = '';
                    let backContent = '';

                    if(slot.is_filled) {
                        if (isOpened) {
                            // [ê³µê°œ] ì‹¤ì œ ì´ë¯¸ì§€ + í¸ì§€
                            const t = new Date().getTime();
                            frontContent = `<img src="/img/${myRoomId}/${slot.position}?t=${t}">`;
                            backContent = `<strong>From. ${slot.user}</strong><div class="msg">${slot.message}</div>`;
                        } else {
                            // [ë¹„ê³µê°œ] ì„ ë¬¼ ìƒì ì•„ì´ì½˜
                            frontContent = `<div class="locked-gift">ğŸ</div>`;
                            backContent = `<div style="color:#C62828; font-weight:bold;">D-Day ê³µê°œ</div>`;
                        }
                    } else {
                        // ë¹ˆì¹¸
                        frontContent = `<div style="font-size:24px; font-weight:bold; color:#8D6E63;">${slot.char}</div>`;
                        backContent = `<div style="color:#aaa">ë¹„ì–´ìˆìŒ</div>`;
                    }

                    el.innerHTML = `
                        <div class="flip-inner">
                            <div class="flip-front ${slot.is_filled?'':'empty'}">${frontContent}</div>
                            <div class="flip-back">${backContent}</div>
                        </div>
                    `;
                }
                rowDiv.appendChild(el);
            });
            box.appendChild(rowDiv);
        }

        function updateMessageList(slots) {
            const list = document.getElementById('message-list');
            const filled = slots.filter(s => s.is_filled);
            
            if(filled.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#666; padding: 20px;">ì•„ì§ ë„ì°©í•œ í¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            list.innerHTML = '';
            filled.forEach(s => {
                const t = new Date().getTime();
                const div = document.createElement('div');
                div.className = 'msg-item';
                
                // ê³µê°œ ì—¬ë¶€ì— ë”°ë¥¸ ë‚´ìš© ì²˜ë¦¬
                let imgSrc = isOpened ? `/img/${myRoomId}/${s.position}?t=${t}` : ''; 
                let imgTag = isOpened ? `<img src="${imgSrc}" class="msg-img">` : `<div class="msg-icon">ğŸ</div>`;
                
                let userText = isOpened ? s.user : 'ìµëª…ì˜ ì¹œêµ¬';
                let msgText = isOpened ? s.message : '<span class="blur-text">D-Dayì— ê³µê°œë˜ëŠ” ë¹„ë°€ ë©”ì‹œì§€ì…ë‹ˆë‹¤.</span>';

                div.innerHTML = `
                    ${imgTag}
                    <div class="msg-info">
                        <div class="msg-user">${userText} (${s.char})</div>
                        <div class="msg-body">${msgText}</div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        async function makeFinalCard() {
            if(!myRoomId) return;
            const btn = document.getElementById('make-btn');
            btn.disabled = true; btn.innerText = "â³ ë‹ˆíŠ¸ ì§œëŠ” ì¤‘...";

            try {
                await fetch(`/make-card/${myRoomId}`, { method: 'POST' });
                await checkFinalCard(); 
                alert("ì¹´ë“œê°€ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ");
            } catch(e) { alert("ìƒì„± ì‹¤íŒ¨"); }
            
            btn.disabled = false; btn.innerText = "ğŸ ìµœì¢… ì¹´ë“œ ë‹¤ì‹œ ë§Œë“¤ê¸°";
        }

        async function checkFinalCard() {
            const res = await fetch(`/result_card/${myRoomId}`);
            if(res.ok) {
                const wrapper = document.getElementById('result-wrapper');
                const img = document.getElementById('final-img');
                img.src = `/result_card/${myRoomId}?t=` + new Date().getTime();
                wrapper.style.display = 'block';
                wrapper.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // [ë‹µì¥ ì“°ê¸° ê¸°ëŠ¥]
        function showReplyForm() {
            document.getElementById('reply-form').style.display = 'block';
            document.getElementById('hostReplyText').focus();
        }

        function saveReply() {
            const text = document.getElementById('hostReplyText').value;
            if(!text) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            
            const card = document.getElementById('host-reply-card');
            const display = document.getElementById('reply-content-display');
            display.innerText = text;
            
            card.style.display = 'block';
            document.getElementById('reply-form').style.display = 'none';
            alert("ë‹µì¥ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! (ì´ í™”ë©´ì„ ìº¡ì²˜í•´ì„œ ì¹œêµ¬ë“¤ì—ê²Œ ë³´ë‚´ì£¼ì„¸ìš”)");
        }

        function copyLink() {
            const url = document.getElementById('share-link').href;
            navigator.clipboard.writeText(url).then(() => alert("ë§í¬ ë³µì‚¬ ì™„ë£Œ!"));
        }

        function downloadImg() {
            const src = document.getElementById('final-img').src;
            if(!src) return;
            const a = document.createElement('a');
            a.href = src; a.download = `Knitting_Card_${myRoomId}.jpg`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function goHome() {
            if(confirm("ì²« í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) window.location.href = "/host";
        }
    </script>
</body>
</html>
