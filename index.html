<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knitting Happy</title>
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js" integrity="sha384-TiCUE00h649CAMonG018J2ujOgDKW/kVWlChEuu4jK2txfTZ060z1kAJGG+uHuha" crossorigin="anonymous"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        * { box-sizing: border-box; } 

        body { font-family: 'Pretendard', sans-serif; background-color: #3e2723; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; perspective: 1000px; }

        .screen { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white; background: #3e2723; transition: 0.3s; z-index: 100;}
        .hidden { display: none !important; }

        /* ê²°ê³¼ í™”ë©´ ì´ë¯¸ì§€ ë¹„ìœ¨ ê³ ì • (ì§œë¶€ í•´ê²°) */
        #final-screen img { 
            max-width: 100%; 
            max-height: 55vh; 
            width: auto; /* ê°€ë¡œ ë¹„ìœ¨ ìë™ */
            height: auto; /* ì„¸ë¡œ ë¹„ìœ¨ ìë™ */
            object-fit: contain; /* ë¹„ìœ¨ ìœ ì§€í•˜ë©° ìƒì ì•ˆì— ë§ì¶¤ */
            border-radius: 5px; 
            border: 2px solid #5d4037; 
        }

        .scene { width: 340px; height: 520px; /* íˆ´ë°” ê³µê°„ í™•ë³´ë¥¼ ìœ„í•´ ë†’ì´ ì¦ê°€ */ position: relative; display: none; z-index: 50; margin-bottom: 60px; }
        .card { width: 100%; height: 100%; position: absolute; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1); border-radius: 15px; }
        .card.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 15px; overflow: hidden; background: white; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        .card-front { pointer-events: auto; z-index: 2; display: flex; flex-direction: column; background: #d7ccc8; } 
        .card-back { pointer-events: none; z-index: 1; transform: rotateY(180deg); background: #fffdf5; padding: 30px; box-sizing: border-box; display: flex; flex-direction: column; text-align: center; color: #333; }
        .card.is-flipped .card-front { pointer-events: none; }
        .card.is-flipped .card-back { pointer-events: auto; }

        .canvas-area { flex: 1; position: relative; cursor: crosshair; overflow: hidden; background: #d7ccc8; }
        
        .guide-char { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            font-size: 300px; font-weight: 900; color: #5d4037; opacity: 0.15; 
            pointer-events: none; user-select: none; z-index: 0; 
        }
        
        canvas { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 10; }
        
        /* íˆ´ë°” ìŠ¤íƒ€ì¼ (2ë‹¨ êµ¬ì„±) */
        .tools { height: 100px; background: #5d4037; display: flex; flex-direction: column; padding: 10px; gap: 8px; border-top: 4px solid #4e342e; z-index: 20; border-radius: 0 0 15px 15px;}
        .tool-row { display: flex; justify-content: center; align-items: center; gap: 10px; width: 100%; }
        
        .tool-btn { width: 35px; height: 35px; border-radius: 5px; border: 2px solid rgba(255,255,255,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: 0.2s; background: #8d6e63; color: #d7ccc8;}
        .tool-btn.active { border-color: white; background: #a1887f; color: white; box-shadow: 0 0 5px white; }
        
        .color-btn { width: 35px; height: 35px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.2); cursor: pointer; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); transition: 0.2s;}
        .color-btn.active { transform: scale(1.1); border-color: white; box-shadow: 0 0 10px white; }
        .trash-btn { background: #6d4c41; color: white; border: 1px solid #8d6e63; font-size: 16px; border-radius: 50%; width: 35px; height: 35px; margin-left: auto;}

        textarea { width: 100%; flex: 1; padding: 15px; border: 2px dashed #ccc; background: transparent; font-size: 16px; font-family: inherit; resize: none; border-radius: 10px; margin-bottom: 20px; }

        input.intro-input { padding: 15px; font-size: 20px; border-radius: 30px; border: none; text-align: center; width: 250px; margin-top: 20px;}
        button.btn-main { padding: 15px 40px; font-size: 18px; border-radius: 30px; border: none; background: #00c853; color: white; margin-top: 20px; cursor: pointer; font-weight: bold; box-shadow: 0 5px 15px rgba(0,200,83,0.3); }
        
        .action-bar { position: fixed; bottom: 30px; left: 0; width: 100%; display: flex; justify-content: center; gap: 20px; z-index: 999; pointer-events: none; }
        .btn-circle { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 24px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; pointer-events: auto; transition: transform 0.2s; }
        .btn-flip { background: white; color: #333; }
        .btn-send { background: #d63384; color: white; }
        .btn-circle:active { transform: scale(0.9); }

        .top-guide { position: absolute; top: -60px; width: 100%; text-align: center; color: #ffecb3; font-size: 18px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        
        .kakao-btn { background-color: #FEE500; color: #000; padding: 12px 20px; border-radius: 30px; border: none; font-weight: bold; display: flex; align-items: center; gap: 8px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="intro-screen" class="screen">
        <h1 style="font-size: 40px; margin-bottom: 5px;">Knitting Mate</h1>
        <p style="opacity: 0.8;">ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜ ë§Œë“œëŠ” ë‹ˆíŠ¸ ì¹´ë“œ ğŸ§¶</p>
        <input type="text" id="userName" class="intro-input" placeholder="ì´ë¦„ì´ ë­”ê°€ìš”?">
        <button class="btn-main" onclick="checkStart()">ì‹œì‘í•˜ê¸°</button>
    </div>

    <div id="waiting-screen" class="screen hidden">
        <h1 style="font-size: 60px;">ğŸ§µ</h1>
        <h2>í•œ ë•€ í•œ ë•€ ì €ì¥ ì™„ë£Œ!</h2>
        <p>ì¹œêµ¬ë“¤ì´ ë‹¤ ëœ° ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
        <div style="margin-top:20px; font-size: 24px; color: #81c784; font-weight: bold;" id="open-time-display"></div>
    </div>

    <div id="final-screen" class="screen hidden" style="background: #222;">
        <h1 style="color: #ffecb3;">MERRY CHRISTMAS!</h1>
        <div style="margin: 20px; padding: 10px; background: #3e2723; border-radius: 10px; display: flex; justify-content: center;">
            <img src="" alt="ì™„ì„±ëœ ì¹´ë“œ">
        </div>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
            <button class="btn-main" style="background-color: #2979ff; margin:0; padding: 10px 20px; font-size: 14px;" onclick="downloadResult()">ì´ë¯¸ì§€ ì €ì¥ ğŸ’¾</button>
            <button class="kakao-btn" onclick="shareKakao()">
                <img src="https://developers.kakao.com/assets/img/about/logos/kakaotalksharing/kakaotalk_sharing_btn_small.png" width="20"> ê³µìœ í•˜ê¸°
            </button>
        </div>
        <p style="font-size:12px; color:#666; margin-top: 15px;">ìƒˆë¡œê³ ì¹¨í•˜ë©´ ìµœì‹  ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</p>
    </div>

    <div class="scene" id="workspace">
        <div class="top-guide" id="guideText">ğŸ§¶ ì¹¸ì„ ì±„ì›Œ ë¬´ëŠ¬ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”</div>
        
        <div class="card" id="mainCard">
            <div class="card-face card-front">
                <div class="canvas-area" id="canvasContainer">
                    <div class="guide-char" id="targetChar">?</div>
                    <canvas id="drawingCanvas"></canvas>
                </div>
                <div class="tools">
                    <div class="tool-row" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;">
                        <span style="color:#d7ccc8; font-size:12px;">ìŠ¤í‹°ì¹˜:</span>
                        <div class="tool-btn active" onclick="setShape('heart', this)">â™¥</div>
                        <div class="tool-btn" onclick="setShape('circle', this)">â—</div>
                        <div class="tool-btn" style="font-size: 14px;" onclick="setShape('v-stitch', this)">âˆ¨</div>
                    </div>
                    <div class="tool-row">
                        <span style="color:#d7ccc8; font-size:12px;">ìƒ‰ìƒ:</span>
                        <div class="color-btn active" style="background:#b71c1c" onclick="setColor('#b71c1c', this)"></div> <div class="color-btn" style="background:#2e7d32" onclick="setColor('#2e7d32', this)"></div> <div class="color-btn" style="background:#fff9c4" onclick="setColor('#fff9c4', this)"></div> <div class="tool-btn" style="margin-left: 10px;" onclick="setEraser(this)">âœ‚ï¸ ì§€ìš°ê°œ</div>
                        <button class="trash-btn" onclick="clearAll()">ğŸ—‘ï¸</button>
                    </div>
                </div>
            </div>
            <div class="card-face card-back">
                <h2>To. Friends</h2>
                <textarea id="letterMsg" placeholder="ë”°ëœ»í•œ ë©”ì‹œì§€ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”..."></textarea>
                <div style="font-size:12px; color:#999">From. <span id="display-name"></span></div>
            </div>
        </div>
    </div>

    <div class="action-bar" id="actionBar" style="display:none;">
        <button class="btn-circle btn-flip" onclick="flipCard()">ğŸ”„</button>
        <button class="btn-circle btn-send" onclick="submitCard()">ğŸ§¶</button>
    </div>

    <script>
        const PIXEL_SIZE = 16;  
        const FABRIC_DOT_COLOR = "#bcaaa4"; 
        
        let myName = "";
        let isFlipped = false;
        let canvas, ctx, painting = false;
        let currentColor = "#b71c1c"; 
        let currentShape = "heart"; // ê¸°ë³¸ ìŠ¤í‹°ì¹˜ ëª¨ì–‘
        let isEraserMode = false;
        let cols, rows;

        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');

        window.onload = function() {
            fetch('/api/config').then(r=>r.json()).then(d=>{
                if(d.kakao_key) Kakao.init(d.kakao_key);
            });
        };

        if (!roomId) {
            alert("ë°© ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
            document.body.innerHTML = "<h1 style='color:white;'>ì˜ëª»ëœ ì ‘ê·¼</h1>";
        }

        async function checkStart() {
            const nameInput = document.getElementById('userName');
            if(!nameInput.value.trim()) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            myName = nameInput.value;

            try {
                const res = await fetch(`/status/${roomId}`);
                const status = await res.json();
                
                if(status.error) return alert("ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");

                if(status.is_open) {
                    document.querySelector('#final-screen img').src = `/result_card/${roomId}`;
                    showScreen('final-screen');
                    return;
                }

                const reserveRes = await fetch(`/reserve/${roomId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_name: myName, message: "" })
                });
                const reserveData = await reserveRes.json();

                if(reserveData.status === "TIME_OVER") {
                    alert(reserveData.message);
                    location.reload(); return;
                }

                if (reserveData.status === "SUCCESS") {
                    startDecorating(reserveData.assigned_char);
                } else {
                    if(confirm("ìë¦¬ê°€ ê½‰ ì°¼ìŠµë‹ˆë‹¤! â˜… ëª¨ì–‘ì„ ê¾¸ë¯¸ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        startDecorating("â˜…");
                    } else {
                        showWaiting(status.open_time);
                    }
                }
            } catch(e) { alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨"); }
        }

        function startDecorating(char) {
            showScreen('workspace');
            document.getElementById('workspace').style.display = 'block';
            document.getElementById('actionBar').style.display = 'flex';
            document.getElementById('targetChar').innerText = char;
            document.getElementById('display-name').innerText = myName;
            
            setTimeout(initCanvas, 100);
            alert(`[ ${char} ] ëª¨ì–‘ì„ ëœ¨ê°œì§ˆí•´ì£¼ì„¸ìš”! ğŸ§¶\në„êµ¬í•¨ì—ì„œ ìŠ¤í‹°ì¹˜ ëª¨ì–‘ì„ ë°”ê¿€ ìˆ˜ ìˆì–´ìš”.`);
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
            document.getElementById('workspace').style.display = 'none';
            document.getElementById('actionBar').style.display = 'none';
            const target = document.getElementById(id);
            if(target) target.classList.remove('hidden');
        }

        function showWaiting(timeStr) {
            showScreen('waiting-screen');
            const dateObj = new Date(timeStr);
            const timeDisplay = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            document.getElementById('open-time-display').innerText = `${timeDisplay} OPEN`;
        }

        function flipCard() {
            isFlipped = !isFlipped;
            const card = document.getElementById('mainCard');
            const guide = document.getElementById('guideText');
            painting = false; 
            if(isFlipped) {
                card.classList.add('is-flipped');
                guide.innerText = "âœï¸ ì¹œêµ¬ë“¤ì—ê²Œ í•œë§ˆë””";
            } else {
                card.classList.remove('is-flipped');
                guide.innerText = "ğŸ§¶ ì¹¸ì„ ì±„ì›Œ ë¬´ëŠ¬ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”";
            }
        }

        function initCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            const container = document.getElementById('canvasContainer');
            
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;

            cols = Math.floor(canvas.width / PIXEL_SIZE);
            rows = Math.floor(canvas.height / PIXEL_SIZE);

            drawFabricPattern();

            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mouseup', endDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('touchstart', startDraw);
            canvas.addEventListener('touchend', endDraw);
            canvas.addEventListener('touchmove', draw);
        }

        function drawFabricPattern() {
            ctx.fillStyle = FABRIC_DOT_COLOR;
            for (let i = 0; i < cols; i++) {
                for (let j = 0; j < rows; j++) {
                    const cx = i * PIXEL_SIZE + PIXEL_SIZE/2;
                    const cy = j * PIXEL_SIZE + PIXEL_SIZE/2;
                    ctx.beginPath();
                    ctx.arc(cx, cy, 1.5, 0, Math.PI*2); 
                    ctx.fill();
                }
            }
        }

        function restoreDot(c, r) {
            const cx = c * PIXEL_SIZE + PIXEL_SIZE/2;
            const cy = r * PIXEL_SIZE + PIXEL_SIZE/2;
            ctx.fillStyle = FABRIC_DOT_COLOR;
            ctx.beginPath();
            ctx.arc(cx, cy, 1.5, 0, Math.PI*2);
            ctx.fill();
        }

        // [ë„í˜• ê·¸ë¦¬ê¸° í•¨ìˆ˜ë“¤]
        function drawStitch(ctx, x, y, size, color, shape) {
            ctx.fillStyle = color;
            ctx.strokeStyle = color;
            const s = size * 0.85;
            const padding = (size - s) / 2;
            const ox = x + padding;
            const oy = y + padding;

            ctx.beginPath();
            if (shape === 'heart') {
                const topCurveHeight = s * 0.3;
                ctx.moveTo(ox + s / 2, oy + topCurveHeight + (s*0.1));
                ctx.bezierCurveTo(ox + s / 2, oy+(s*0.1), ox, oy+(s*0.1), ox, oy + topCurveHeight + (s*0.1));
                ctx.bezierCurveTo(ox, oy + (s + topCurveHeight) / 2 + (s*0.1), ox + s / 2, oy + s + (s*0.1), ox + s / 2, oy + s + (s*0.1));
                ctx.bezierCurveTo(ox + s / 2, oy + s + (s*0.1), ox + s, oy + (s + topCurveHeight) / 2 + (s*0.1), ox + s, oy + topCurveHeight + (s*0.1));
                ctx.bezierCurveTo(ox + s, oy+(s*0.1), ox + s / 2, oy+(s*0.1), ox + s / 2, oy + topCurveHeight + (s*0.1));
                ctx.fill();
            } else if (shape === 'circle') {
                ctx.arc(ox + s/2, oy + s/2, s/2, 0, Math.PI*2);
                ctx.fill();
            } else if (shape === 'v-stitch') {
                ctx.lineWidth = s * 0.2;
                ctx.lineCap = 'round';
                ctx.moveTo(ox, oy);
                ctx.lineTo(ox + s/2, oy + s);
                ctx.lineTo(ox + s, oy);
                ctx.stroke();
            }
        }

        function startDraw(e) { painting = true; draw(e); }
        function endDraw() { painting = false; ctx.beginPath(); }
        
        function draw(e) {
            if (!painting) return;
            e.preventDefault();

            const rect = canvas.getBoundingClientRect();
            let clientX = e.touches ? e.touches[0].clientX : e.clientX;
            let clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const x = clientX - rect.left;
            const y = clientY - rect.top;

            const c = Math.floor(x / PIXEL_SIZE);
            const r = Math.floor(y / PIXEL_SIZE);
            const rectX = c * PIXEL_SIZE;
            const rectY = r * PIXEL_SIZE;

            ctx.clearRect(rectX, rectY, PIXEL_SIZE, PIXEL_SIZE);

            if (isEraserMode) {
                restoreDot(c, r);
            } else {
                // ì„ íƒëœ ëª¨ì–‘ìœ¼ë¡œ ê·¸ë¦¬ê¸°
                drawStitch(ctx, rectX, rectY, PIXEL_SIZE, currentColor, currentShape);
            }
        }

        // [íˆ´ë°” ì»¨íŠ¸ë¡¤ í•¨ìˆ˜ë“¤]
        function setShape(shape, btn) {
            currentShape = shape;
            isEraserMode = false;
            updateToolUI(btn, null);
        }

        function setColor(color, btn) {
            currentColor = color;
            isEraserMode = false;
            updateToolUI(null, btn);
        }

        function setEraser(btn) {
            isEraserMode = true;
            updateToolUI(btn, null); // ì§€ìš°ê°œëŠ” ëª¨ì–‘ ë²„íŠ¼ì²˜ëŸ¼ ì·¨ê¸‰
        }

        function updateToolUI(activeToolBtn, activeColorBtn) {
            if (activeToolBtn) {
                document.querySelectorAll('.tool-row:first-child .tool-btn, .tool-btn:contains("ì§€ìš°ê°œ")').forEach(b => b.classList.remove('active'));
                activeToolBtn.classList.add('active');
            }
            if (activeColorBtn) {
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                activeColorBtn.classList.add('active');
            }
            if (!isEraserMode && !activeColorBtn) {
                 // ì§€ìš°ê°œ ëª¨ë“œê°€ í•´ì œë˜ë©´ í˜„ì¬ ìƒ‰ìƒ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™” í‘œì‹œ
                 document.querySelectorAll('.color-btn').forEach(b => {
                     if(b.getAttribute('onclick').includes(currentColor)) b.classList.add('active');
                 });
            }
        }


        function clearAll() {
            if(confirm("ì²˜ìŒë¶€í„° ë‹¤ì‹œ ëœ¨ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawFabricPattern(); 
            }
        }

        function downloadResult() {
            const img = document.querySelector('#final-screen img');
            if (!img || !img.src) return alert("ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
            const link = document.createElement('a');
            link.href = img.src;
            link.download = `Knitting_Card_${roomId}.jpg`; 
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function shareKakao() {
            if(!roomId) return;
            const shareUrl = window.location.origin + "/?room=" + roomId;
            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: 'ğŸ„ í¬ê·¼í•œ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ë‹ˆíŠ¸ ì¹´ë“œ',
                    description: 'ì¹œêµ¬ë“¤ì´ í•œ ë•€ í•œ ë•€ ë– ì„œ ë§Œë“  ì¹´ë“œê°€ ë„ì°©í–ˆì–´ìš”!',
                    imageUrl: document.querySelector('#final-screen img').src, 
                    link: { mobileWebUrl: shareUrl, webUrl: shareUrl },
                },
                buttons: [ { title: 'ì¹´ë“œ êµ¬ê²½í•˜ê¸°', link: { mobileWebUrl: shareUrl, webUrl: shareUrl } } ]
            });
        }

        async function submitCard() {
            const msg = document.getElementById('letterMsg').value;
            if(!msg) return alert("ë’·ë©´ì— ë©”ì‹œì§€ë¥¼ ì¨ì£¼ì„¸ìš”!");
            
            const imageData = document.getElementById('drawingCanvas').toDataURL("image/png");
            
            const res = await fetch(`/join/${roomId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_name: myName, message: msg, image_data: imageData })
            });
            const data = await res.json();

            if(data.status === 'SUCCESS' || data.status === 'FULL') {
                alert("ì €ì¥ ì™„ë£Œ! ë”°ëœ»í•œ ë§ˆìŒì´ ì „ë‹¬ë˜ì—ˆì–´ìš” ğŸ§¶");
                const statusRes = await fetch(`/status/${roomId}`);
                const status = await statusRes.json();
                showWaiting(status.open_time);
            } else {
                alert("ì˜¤ë¥˜: " + (data.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
            }
        }
    </script>
</body>
</html>
