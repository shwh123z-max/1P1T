<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONE TYPE ONE LETTER - GUEST</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff;
            color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            perspective: 1000px;
            overflow: hidden;
            /* Prevent scrolling */
        }

        .screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: #ffffff;
            transition: 0.3s;
            z-index: 100;
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        h1 {
            font-size: 48px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: -2px;
            margin: 0 0 10px 0;
            line-height: 0.9;
        }

        p {
            font-size: 14px;
            color: #666;
            margin-bottom: 30px;
        }

        /* Inputs & Buttons */
        input.intro-input {
            padding: 15px;
            font-size: 18px;
            border: none;
            border-bottom: 2px solid #000;
            text-align: center;
            width: 250px;
            margin-top: 20px;
            background: transparent;
            font-family: 'Inter', sans-serif;
            font-weight: bold;
            outline: none;
            border-radius: 0;
        }

        button.btn-main {
            padding: 15px 40px;
            font-size: 16px;
            border: none;
            background: #000;
            color: white;
            margin-top: 30px;
            cursor: pointer;
            font-weight: 700;
            text-transform: uppercase;
            border-radius: 0;
            transition: background 0.2s;
        }

        button.btn-main:hover {
            background: #333;
        }

        /* Card Scene */
        .scene {
            width: 340px;
            height: 340px;
            position: relative;
            display: none;
            z-index: 50;
            /* margin-bottom removed to center better */
        }

        .card {
            width: 100%;
            height: 100%;
            position: absolute;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
            border: 2px solid #000;
            /* Minimalist border */
        }

        .card.is-flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            background: white;
            overflow: hidden;
        }

        .card-front {
            pointer-events: auto;
            z-index: 2;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
        }

        .card-back {
            pointer-events: auto;
            z-index: 1;
            transform: rotateY(180deg);
            background: #fff;
            padding: 30px;
            display: flex;
            flex-direction: column;
            text-align: center;
            color: #000;
        }

        .card.is-flipped .card-back {
            z-index: 5;
        }

        .card.is-flipped .card-front {
            z-index: 0;
        }

        .canvas-area {
            width: 100%;
            height: 100%;
            position: relative;
            cursor: crosshair;
            overflow: hidden;
            background: #f5f5f5;
        }

        .guide-char {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 200px;
            font-weight: 900;
            color: #000;
            opacity: 0.05;
            pointer-events: none;
            user-select: none;
            z-index: 20;
        }

        canvas {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }

        /* Tools - Minimalist below card */
        .tools-container {
            position: absolute;
            bottom: -100px;
            /* Below the card */
            left: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .tool-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .shape-btn {
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #ccc;
            border: 1px solid transparent;
        }

        .shape-btn.active {
            color: #000;
            font-weight: bold;
            border-bottom: 2px solid #000;
        }

        .color-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 1px solid #ddd;
            transition: transform 0.2s;
        }

        .color-btn.active {
            transform: scale(1.3);
            border: 2px solid #000;
        }

        .eraser-btn {
            font-size: 14px;
        }

        .trash-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #999;
        }

        .trash-btn:hover {
            color: #000;
        }

        textarea {
            width: 100%;
            flex: 1;
            padding: 15px;
            border: 2px solid #eee;
            background: #fafafa;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            resize: none;
            margin-bottom: 20px;
            outline: none;
        }

        textarea:focus {
            border-color: #000;
        }

        /* Action Bar */
        .action-bar {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 999;
        }

        .btn-circle {
            width: 50px;
            height: 50px;
            border-radius: 0;
            /* Square buttons */
            border: 2px solid #000;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
            background: #fff;
            color: #000;
        }

        .btn-circle:hover {
            background: #000;
            color: #fff;
        }

        .btn-send {
            background: #000;
            color: #fff;
        }

        .btn-send:hover {
            background: #333;
        }

        .top-guide {
            position: absolute;
            top: -40px;
            width: 100%;
            text-align: center;
            color: #000;
            font-size: 14px;
            font-weight: bold;
        }

        /* Final Screen */
        #final-screen img {
            max-width: 100%;
            max-height: 100%;
            /* Border removed to avoid double border */
            /* Box shadow removed */
        }

        @media (max-width: 360px) {
            .scene {
                transform: scale(0.85);
            }

            h1 {
                font-size: 36px;
            }
        }
    </style>
</head>

<body>
    <div id="intro-screen" class="screen">
        <h1>ONE TYPE<br>ONE LETTER</h1>
        <p>ì´ˆëŒ€ì¥</p>
        <input type="text" id="userName" class="intro-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
        <button class="btn-main" onclick="checkStart()">ì‹œì‘í•˜ê¸°</button>
    </div>

    <div id="waiting-screen" class="screen hidden">
        <h1 style="font-size: 80px;">â³</h1>
        <h2>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</h2>
        <p>ì¹œêµ¬ë“¤ì´ ëª¨ë‘ ì¹´ë“œë¥¼ ì™„ì„±í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”.</p>
        <div style="margin-top:20px; font-size: 20px; font-weight: 900;" id="open-time-display"></div>
    </div>

    <div id="final-screen" class="screen hidden">
        <h1 style="color: #000;">ìƒˆí•´ ë³µ ë§ì´ ë°›ìœ¼ì„¸ìš”!</h1>

        <!-- Removed fixed margin, will be handled by JS resizing -->
        <div class="scene" id="finalScene" style="display:block; margin: 20px auto; width: 340px; height: 340px;">
            <div class="card" id="finalCard" onclick="flipFinalCard()">
                <!-- Changed background to #f5f5f5 to match image -->
                <div class="card-face card-front"
                    style="background:#f5f5f5; border:none; display:flex; align-items:center; justify-content:center;">
                    <img id="final-card-img" src="" alt="Waiting for Host..."
                        style="max-width:100%; max-height:100%; object-fit:contain; display:none;"
                        onload="adjustCardSize(this)" onerror="this.style.display='none'">
                    <div id="no-image-msg" style="display:none; color:#999; font-size:14px;">í˜¸ìŠ¤íŠ¸ê°€ ìµœì¢… ì¹´ë“œë¥¼ ì™„ì„±
                        ì¤‘ì…ë‹ˆë‹¤...<br>(í´ë¦­í•´ì„œ ë©”ì‹œì§€ í™•ì¸)</div>
                </div>
                <div class="card-face card-back">
                    <h2 style="font-size:18px; text-transform:uppercase;">From. í˜¸ìŠ¤íŠ¸</h2>
                    <div id="host-message-display" style="white-space: pre-wrap; font-size:16px; line-height:1.5;">
                    </div>
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 10px; justify-content:center; margin-top:20px;">
            <button class="btn-main" style="margin:0; background:#fff; color:#000; border:2px solid #000;"
                onclick="downloadResult()">ì´ë¯¸ì§€ ì €ì¥</button>
            <button class="btn-main" style="margin:0;" onclick="copyLink()">ë§í¬ ë³µì‚¬</button>
        </div>
        <div style="margin-top:10px; color:#666; font-size:12px;">ì¹´ë“œë¥¼ í´ë¦­í•´ì„œ ë’¤ì§‘ì–´ë³´ì„¸ìš”</div>
    </div>

    <div class="scene" id="workspace">
        <div class="top-guide" id="guideText">ê¸€ìë¥¼ ì˜ˆì˜ê²Œ ê¾¸ë©°ì£¼ì„¸ìš”!</div>
        <div class="card" id="mainCard">
            <div class="card-face card-front">
                <div class="canvas-area" id="canvasContainer">
                    <div class="guide-char" id="targetChar">?</div>
                    <canvas id="drawingCanvas"></canvas>
                </div>
            </div>
            <div class="card-face card-back">
                <h2 style="font-size:18px; text-transform:uppercase;">To. <span id="to-host-name">Host</span></h2>
                <textarea id="letterMsg" placeholder="ì¹œêµ¬ì—ê²Œ ë³´ë‚¼ ìƒˆí•´ ì¸ì‚¬ë¥¼ ì ì–´ì£¼ì„¸ìš”..."></textarea>
                <div style="font-size:12px; color:#999; text-align:right;">From. <span id="display-name"></span></div>
            </div>
        </div>

        <!-- Tools moved outside card -->
        <div class="tools-container">
            <div class="tool-row">
                <div class="shape-btn active" onclick="setShape('heart', this)">â™¥</div>
                <div class="shape-btn" onclick="setShape('circle', this)">â—</div>
                <div class="shape-btn" onclick="setShape('v-stitch', this)">âˆ¨</div>
                <div class="shape-btn eraser-btn" onclick="setEraser(this)">ì§€ìš°ê°œ</div>
                <button class="trash-btn" onclick="clearAll()">ğŸ—‘ï¸</button>
            </div>
            <div class="tool-row">
                <div class="color-btn active" style="background:#A14343" onclick="setColor('#A14343', this)"></div>
                <div class="color-btn" style="background:#2e7d32" onclick="setColor('#2e7d32', this)"></div>
                <div class="color-btn" style="background:#fdd835" onclick="setColor('#fdd835', this)"></div>
                <div class="color-btn" style="background:#000000" onclick="setColor('#000000', this)"></div>
                <div class="color-btn" style="background:#ffffff; border:1px solid #ccc;"
                    onclick="setColor('#ffffff', this)"></div>
            </div>
        </div>
    </div>

    <div class="action-bar" id="actionBar" style="display:none;">
        <button class="btn-circle btn-flip" onclick="flipCard()">â†»</button>
        <button class="btn-circle btn-send" onclick="submitCard()">OK</button>
    </div>

    <script>
        const PIXEL_SIZE = 17; // Slightly larger for 340px (20x20 grid)
        const FABRIC_DOT_COLOR = "#e0e0e0";
        const BG_COLOR = "#f5f5f5";

        let myName = ""; let isFlipped = false; let canvas, ctx, painting = false;
        let currentColor = "#A14343"; let currentShape = "heart"; let isEraserMode = false;
        let cols, rows;

        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');

        if (!roomId) { alert("ë°© IDê°€ ì—†ìŠµë‹ˆë‹¤"); document.body.innerHTML = "<h1>ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤</h1>"; }

        async function checkStart() {
            const nameInput = document.getElementById('userName');
            if (!nameInput.value.trim()) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
            myName = nameInput.value;
            try {
                const res = await fetch(`/status/${roomId}`);
                const status = await res.json();
                if (status.error) return alert("ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");

                document.getElementById('to-host-name').innerText = status.host_name || "Host";

                if (status.is_open) {
                    const img = document.querySelector('#final-card-img');
                    img.src = `/result_card/${roomId}`;
                    img.onerror = function () {
                        this.style.display = 'none';
                        document.getElementById('no-image-msg').style.display = 'block';
                    };
                    document.getElementById('host-message-display').innerText = status.host_message || "í˜¸ìŠ¤íŠ¸ì˜ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.";
                    showScreen('final-screen'); return;
                }
                const reserveRes = await fetch(`/reserve/${roomId}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_name: myName, message: "" })
                });
                const reserveData = await reserveRes.json();
                if (reserveData.status === "TIME_OVER") { alert(reserveData.message); location.reload(); return; }
                if (reserveData.status === "SUCCESS") startDecorating(reserveData.assigned_char);
                else {
                    if (confirm("ë°©ì´ ê½‰ ì°¼ìŠµë‹ˆë‹¤. íŠ¹ìˆ˜ë¬¸ìë¥¼ ê¾¸ë¯¸ì‹œê² ìŠµë‹ˆê¹Œ?")) startDecorating("â˜…");
                    else showWaiting(status.open_time);
                }
            } catch (e) { alert("ì„œë²„ ì˜¤ë¥˜"); }
        }

        function startDecorating(char) {
            showScreen('workspace');
            document.getElementById('workspace').style.display = 'block';
            document.getElementById('actionBar').style.display = 'flex';
            document.getElementById('targetChar').innerText = char;
            document.getElementById('display-name').innerText = myName;
            setTimeout(initCanvas, 100);
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
            document.getElementById('workspace').style.display = 'none';
            document.getElementById('actionBar').style.display = 'none';
            const target = document.getElementById(id);
            if (target) target.classList.remove('hidden');
        }
        function showWaiting(timeStr) {
            showScreen('waiting-screen');
            const dateObj = new Date(timeStr);
            document.getElementById('open-time-display').innerText = `${dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} OPEN`;
        }
        function flipCard() {
            isFlipped = !isFlipped;
            const card = document.getElementById('mainCard');
            const guide = document.getElementById('guideText');
            painting = false;
            if (isFlipped) { card.classList.add('is-flipped'); guide.innerText = "ë©”ì‹œì§€ë¥¼ ì‘ì„±í•˜ì„¸ìš”"; }
            else { card.classList.remove('is-flipped'); guide.innerText = "í”½ì…€ì„ ì±„ì›Œì£¼ì„¸ìš”"; }
        }

        function flipFinalCard() {
            const card = document.getElementById('finalCard');
            card.classList.toggle('is-flipped');
        }

        function adjustCardSize(img) {
            img.style.display = 'block';
            const scene = document.getElementById('finalScene');
            const maxWidth = Math.min(window.innerWidth - 40, 600); // Max width 600px or screen width

            // Calculate aspect ratio
            const ratio = img.naturalWidth / img.naturalHeight;

            // Set width based on max constraints
            let newWidth = maxWidth;
            let newHeight = newWidth / ratio;

            // Enforce min height for back readability (e.g. 250px)
            if (newHeight < 250) {
                newHeight = 250;
                // If we force height, we might need to adjust width or just let image contain
                // But for the card container, let's keep the width wide and height min 250
            }

            scene.style.width = newWidth + 'px';
            scene.style.height = newHeight + 'px';
        }

        function initCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            const container = document.getElementById('canvasContainer');
            canvas.width = container.offsetWidth; canvas.height = container.offsetHeight;
            cols = Math.floor(canvas.width / PIXEL_SIZE); rows = Math.floor(canvas.height / PIXEL_SIZE);

            ctx.fillStyle = BG_COLOR;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            drawFabricPattern();
            canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mouseup', endDraw); canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('touchstart', startDraw); canvas.addEventListener('touchend', endDraw); canvas.addEventListener('touchmove', draw);
        }

        function drawFabricPattern() {
            ctx.fillStyle = FABRIC_DOT_COLOR;
            for (let i = 0; i < cols; i++) {
                for (let j = 0; j < rows; j++) {
                    const cx = i * PIXEL_SIZE + PIXEL_SIZE / 2;
                    const cy = j * PIXEL_SIZE + PIXEL_SIZE / 2;
                    ctx.beginPath(); ctx.arc(cx, cy, 1.5, 0, Math.PI * 2); ctx.fill();
                }
            }
        }
        function restoreDot(c, r) {
            const rectX = c * PIXEL_SIZE; const rectY = r * PIXEL_SIZE;
            ctx.fillStyle = BG_COLOR;
            ctx.fillRect(rectX, rectY, PIXEL_SIZE, PIXEL_SIZE);
            const cx = rectX + PIXEL_SIZE / 2; const cy = rectY + PIXEL_SIZE / 2;
            ctx.fillStyle = FABRIC_DOT_COLOR;
            ctx.beginPath(); ctx.arc(cx, cy, 1.5, 0, Math.PI * 2); ctx.fill();
        }

        function drawStitch(ctx, x, y, size, color, shape) {
            ctx.fillStyle = color; ctx.strokeStyle = color;
            const s = size * 0.85; const padding = (size - s) / 2;
            const ox = x + padding; const oy = y + padding;
            ctx.beginPath();
            if (shape === 'heart') {
                const topCurveHeight = s * 0.3;
                ctx.moveTo(ox + s / 2, oy + topCurveHeight + (s * 0.1));
                ctx.bezierCurveTo(ox + s / 2, oy + (s * 0.1), ox, oy + (s * 0.1), ox, oy + topCurveHeight + (s * 0.1));
                ctx.bezierCurveTo(ox, oy + (s + topCurveHeight) / 2 + (s * 0.1), ox + s / 2, oy + s + (s * 0.1), ox + s / 2, oy + s + (s * 0.1));
                ctx.bezierCurveTo(ox + s / 2, oy + s + (s * 0.1), ox + s, oy + (s + topCurveHeight) / 2 + (s * 0.1), ox + s, oy + topCurveHeight + (s * 0.1));
                ctx.bezierCurveTo(ox + s, oy + (s * 0.1), ox + s / 2, oy + (s * 0.1), ox + s / 2, oy + topCurveHeight + (s * 0.1));
                ctx.fill();
            } else if (shape === 'circle') { ctx.arc(ox + s / 2, oy + s / 2, s / 2, 0, Math.PI * 2); ctx.fill(); }
            else if (shape === 'v-stitch') {
                ctx.lineWidth = s * 0.25; ctx.lineCap = 'round';
                ctx.moveTo(ox, oy); ctx.lineTo(ox + s / 2, oy + s); ctx.lineTo(ox + s, oy); ctx.stroke();
            }
        }

        function startDraw(e) { painting = true; draw(e); }
        function endDraw() { painting = false; ctx.beginPath(); }
        function draw(e) {
            if (!painting) return; e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            let clientX = e.touches ? e.touches[0].clientX : e.clientX;
            let clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const x = clientX - rect.left; const y = clientY - rect.top;
            const c = Math.floor(x / PIXEL_SIZE); const r = Math.floor(y / PIXEL_SIZE);
            const rectX = c * PIXEL_SIZE; const rectY = r * PIXEL_SIZE;

            if (isEraserMode) restoreDot(c, r);
            else {
                ctx.fillStyle = BG_COLOR; ctx.fillRect(rectX, rectY, PIXEL_SIZE, PIXEL_SIZE);
                drawStitch(ctx, rectX, rectY, PIXEL_SIZE, currentColor, currentShape);
            }
        }

        function setShape(shape, btn) { currentShape = shape; isEraserMode = false; updateToolUI(btn, null); }
        function setColor(color, btn) { currentColor = color; isEraserMode = false; updateToolUI(null, btn); }
        function setEraser(btn) { isEraserMode = true; updateToolUI(btn, null); }
        function updateToolUI(activeShapeBtn, activeColorBtn) {
            if (activeShapeBtn) {
                document.querySelectorAll('.shape-btn:not(.eraser-btn)').forEach(b => b.classList.remove('active'));
                document.querySelector('.eraser-btn').classList.remove('active');
                activeShapeBtn.classList.add('active');
            } else if (isEraserMode) {
                document.querySelectorAll('.shape-btn:not(.eraser-btn)').forEach(b => b.classList.remove('active'));
                document.querySelector('.eraser-btn').classList.add('active');
            }
            if (activeColorBtn) {
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                activeColorBtn.classList.add('active');
            }
        }
        function clearAll() {
            if (confirm("ì •ë§ ë‹¤ ì§€ìš°ì‹œê² ì–´ìš”?")) {
                ctx.fillStyle = BG_COLOR; ctx.fillRect(0, 0, canvas.width, canvas.height);
                drawFabricPattern();
            }
        }
        function downloadResult() {
            const img = document.querySelector('#final-screen img');
            if (!img || !img.src) return alert("ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤");
            const link = document.createElement('a'); link.href = img.src; link.download = `Card_${roomId}.jpg`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
        function copyLink() {
            const url = window.location.origin + "/?room=" + roomId;
            navigator.clipboard.writeText(url).then(() => alert("ë³µì‚¬ ì™„ë£Œ!"));
        }
        async function submitCard() {
            const msg = document.getElementById('letterMsg').value;
            if (!msg) return alert("ë©”ì‹œì§€ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”!");
            const imageData = document.getElementById('drawingCanvas').toDataURL("image/png");
            const res = await fetch(`/join/${roomId}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_name: myName, message: msg, image_data: imageData })
            });
            const data = await res.json();
            if (data.status === 'SUCCESS' || data.status === 'FULL') {
                alert("ì „ì†¡ ì™„ë£Œ! í˜¸ìŠ¤íŠ¸ì—ê²Œ ì „ë‹¬ë˜ì—ˆì–´ìš”.");
                const statusRes = await fetch(`/status/${roomId}`);
                const status = await statusRes.json();
                showWaiting(status.open_time);
            } else alert("ì˜¤ë¥˜: " + (data.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
        }
    </script>
</body>

</html>